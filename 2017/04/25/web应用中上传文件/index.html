<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录前端学习成长点滴"><meta name="keywords" content="前端开发"><title>web应用中上传文件 | bolt-像闪电一样</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.3.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.3.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">web应用中上传文件</h1><a id="logo" href="/.">bolt-像闪电一样</a><p class="description">每天进步一点点</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">web应用中上传文件</h1><div class="post-meta">Apr 25, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>使用在HTML5中添加到DOM的File API，现在可以让Web内容要求用户选择本地文件，然后读取这些文件的内容。此选择可以通过使用HTMLinput元素或通过拖放来完成。</p>
<h2 id="访问所选的文件"><a href="#访问所选的文件" class="headerlink" title="访问所选的文件"></a>访问所选的文件</h2><p>考虑下面的HTML：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;input type=&quot;file&quot; id=&quot;input&quot;&gt;</div><div class="line"></div><div class="line">&lt;input type=&quot;file&quot; id=&quot;input&quot; multiple</div></pre></td></tr></table></figure></p>
<p>通过File API,我们可以在用户选取一个或者多个文件之后,访问到代表了所选文件的一个或多个File对象,这些对象被包含在一个FileList对象中.  </p>
<p>如果用户只选择了一个文件,那么我们只需要访问这个FileList对象中的第一个元素.  </p>
<p>可以使用传统的DOM选择方法来获取到用户所选择的文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var selected_file = document.getElementById(&apos;input&apos;).files[0];</div></pre></td></tr></table></figure></p>
<p>还可以使用jQuery选择器来选择：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">var selectedfile = $(&apos;#input&apos;).get(0).files[0];</div><div class="line"></div><div class="line">var selectedFile = $(&apos;#input&apos;)[0].files[0];</div></pre></td></tr></table></figure></p>
<blockquote>
<p>如果你有一个”files is undefined” 错误，那么就是你没有选择正确的HTML元素，忘记了一个jQuery选择器返回的是匹配的DOM元素的列表。用获取的DOM元素调用“files”的方法就可以了。</p>
</blockquote>
<h2 id="在-一个change-事件发生时-访问选择的文件"><a href="#在-一个change-事件发生时-访问选择的文件" class="headerlink" title="在 一个change 事件发生时,访问选择的文件"></a>在 一个change 事件发生时,访问选择的文件</h2><p>另外,还可以在input元素上的change事件触发时再访问它的<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FileList" target="_blank" rel="external">FileList</a>属性（但不是强制性的)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;input type=&quot;file&quot; id=&quot;input&quot; onchange=&quot;handleFiles(this.files)&quot;&gt;</div></pre></td></tr></table></figure></p>
<p>当用户成功选取若干个文件后，handleFiles()函数会被调用，且一个代表用户所选择的文件的包含了<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/File" target="_blank" rel="external">File</a> 对象的<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FileList" target="_blank" rel="external">FileList</a>对象会作为参数传入该函数。</p>
<p>如果你的程序可以让用户选择多个文件,记得要在input元素上加上==multiple==属性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;input type=&quot;file&quot; id=&quot;input&quot; multiple onchange=&quot;handleFiles(this.files)&quot;&gt;</div></pre></td></tr></table></figure></p>
<p>在用户选择了多个文件的情况下，传入handleFiles()函数的文件列表将会包含多个<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/File" target="_blank" rel="external">File</a>对象,每个<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/File" target="_blank" rel="external">File</a>对象对应一个真实的文件。</p>
<h4 id="动态添加change事件监听器"><a href="#动态添加change事件监听器" class="headerlink" title="动态添加change事件监听器"></a>动态添加change事件监听器</h4><p>你还可以通过element.addEventListener()方法来添加多个change事件处理函数,像这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var inputElement = document.getElementById(&quot;inputField&quot;);</div><div class="line">inputElement.addEventListener(&quot;change&quot;, handleFiles, false);</div><div class="line">function handleFiles() &#123;</div><div class="line">  var fileList = this.files; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="获取所选文件的信息"><a href="#获取所选文件的信息" class="headerlink" title="获取所选文件的信息"></a>获取所选文件的信息</h2><p>用户所选择的文件都存储在了一个FileList对象上，其中每个文件都对应了一个File对象。你可以通过这个FileList对象的length属性知道用户一共选择了多少个文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var numFiles = files.length;</div></pre></td></tr></table></figure></p>
<p>可以通过普通的循环语句来操作每个单独的File对象：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">for (var i = 0, numFiles = files.length; i &lt; numFiles; i++) &#123;</div><div class="line">  var file = files[i];</div><div class="line">  ..</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>File对象上有三个属性提供了所包含文件的相关信息.</p>
<ol>
<li>name：文件名,只读字符串,不包含任何路径信息.</li>
<li>size：文件大小,单位为字节,只读的64位整数.</li>
<li>type：MIME类型,只读字符串,如果类型未知,则返回空字符串.</li>
</ol>
<h4 id="显示文件大小"><a href="#显示文件大小" class="headerlink" title="显示文件大小"></a>显示文件大小</h4><p>下面的例子演示了size属性的用法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</div><div class="line">&lt;title&gt;File(s) size&lt;/title&gt;</div><div class="line">&lt;script&gt;</div><div class="line">function updateSize() &#123;</div><div class="line">  var nBytes = 0,</div><div class="line">      oFiles = document.getElementById(&quot;uploadInput&quot;).files,</div><div class="line">      nFiles = oFiles.length;</div><div class="line">  for (var nFileId = 0; nFileId &lt; nFiles; nFileId++) &#123;</div><div class="line">    nBytes += oFiles[nFileId].size;</div><div class="line">  &#125;</div><div class="line">  var sOutput = nBytes + &quot; bytes&quot;;</div><div class="line">  var aMultiples = [&quot;KiB&quot;, &quot;MiB&quot;, &quot;GiB&quot;, &quot;TiB&quot;, &quot;PiB&quot;, &quot;EiB&quot;, &quot;ZiB&quot;, &quot;YiB&quot;], </div><div class="line">      nMultiple = 0, nApprox = nBytes / 1024;</div><div class="line"></div><div class="line">  // optional code for multiples approximation</div><div class="line">  for ( ; nApprox &gt; 1; nApprox /= 1024, nMultiple++) &#123;</div><div class="line">    sOutput = nApprox.toFixed(3) + &quot; &quot; + aMultiples[nMultiple] + &quot; (&quot; + nBytes + &quot; bytes)&quot;;</div><div class="line">  &#125;</div><div class="line">  // end of optional code</div><div class="line">  document.getElementById(&quot;fileNum&quot;).innerHTML = nFiles;</div><div class="line">  document.getElementById(&quot;fileSize&quot;).innerHTML = sOutput;</div><div class="line">&#125;</div><div class="line">&lt;/script&gt;</div><div class="line">&lt;/head&gt;</div><div class="line"></div><div class="line">&lt;body onload=&quot;updateSize();&quot;&gt;</div><div class="line">&lt;form name=&quot;uploadForm&quot;&gt;</div><div class="line">&lt;p&gt;</div><div class="line">  &lt;input id=&quot;uploadInput&quot; type=&quot;file&quot; name=&quot;myFiles&quot; onchange=&quot;updateSize();&quot; multiple&gt;</div><div class="line">    selected files： </div><div class="line">    &lt;span id=&quot;fileNum&quot;&gt;0&lt;/span&gt;; total size： </div><div class="line">    &lt;span id=&quot;fileSize&quot;&gt;0&lt;/span&gt;</div><div class="line">&lt;/p&gt;</div><div class="line">&lt;p&gt;</div><div class="line">  &lt;input type=&quot;submit&quot; value=&quot;Send file&quot;&gt;</div><div class="line">&lt;/p&gt;</div><div class="line">&lt;/form&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<h2 id="在隐藏的文件输入框上调用click-方法"><a href="#在隐藏的文件输入框上调用click-方法" class="headerlink" title="在隐藏的文件输入框上调用click()方法"></a>在隐藏的文件输入框上调用click()方法</h2><p>从Gecko 2.0 (Firefox 4 / Thunderbird 3.3 / SeaMonkey 2.1)开始，你可以隐藏掉默认的的文件输入框input元素，使用自定义的界面来充当打开文件选择对话框的按钮。实现起来很简单，你只需要使用样式display:none把原本的文件输入框隐藏掉，然后在需要的时候调用它的click()方法就行了。</p>
<p>考虑下面的HTML：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;input type=&quot;file&quot; id=&quot;fileElem&quot; multiple accept=&quot;image/*&quot; style=&quot;display:none&quot; onchange=&quot;handleFiles(this.files)&quot;&gt;</div><div class="line">&lt;a href=&quot;#&quot; id=&quot;fileSelect&quot;&gt;Select some files&lt;/a&gt;</div></pre></td></tr></table></figure></p>
<p>处理 click 事件的代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">var fileSelect = document.getElementById(&quot;fileSelect&quot;),</div><div class="line">  fileElem = document.getElementById(&quot;fileElem&quot;);</div><div class="line"></div><div class="line">fileSelect.addEventListener(&quot;click&quot;, function (e) &#123;</div><div class="line">  if (fileElem) &#123;</div><div class="line">    fileElem.click();</div><div class="line">  &#125;</div><div class="line">  e.preventDefault(); // prevent navigation to &quot;#&quot;</div><div class="line">&#125;, false);</div></pre></td></tr></table></figure></p>
<p>这样，你就能任意改变这个文件选择按钮的样式了。</p>
<h2 id="通过拖放操作选择文件"><a href="#通过拖放操作选择文件" class="headerlink" title="通过拖放操作选择文件"></a>通过拖放操作选择文件</h2><p>你可以让用户将本地文件拖放到你的应用程序上</p>
<p>首先要创建一个拖放操作的目的区域。可根据您的应用程序的设计来决定哪部分的内容接受 drop，但创建一个接收drop事件的元素是简单的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">var dropbox;</div><div class="line"></div><div class="line">dropbox = document.getElementById(&quot;dropbox&quot;);</div><div class="line">dropbox.addEventListener(&quot;dragenter&quot;, dragenter, false);</div><div class="line">dropbox.addEventListener(&quot;dragover&quot;, dragover, false);</div><div class="line">dropbox.addEventListener(&quot;drop&quot;, drop, false);</div></pre></td></tr></table></figure></p>
<p>在这个例子中，ID 为 dropbox 的元素所在的区域是我们的拖放目的区域。我们需要在该元素上绑定 dragenter，dragover，和drop 事件。</p>
<p>我们必须阻止dragenter和dragover事件的默认行为，这样才能触发 drop 事件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">function dragenter(e) &#123;</div><div class="line">  e.stopPropagation();</div><div class="line">  e.preventDefault();</div><div class="line">&#125;</div><div class="line"></div><div class="line">function dragover(e) &#123;</div><div class="line">  e.stopPropagation();</div><div class="line">  e.preventDefault();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下面是 drop 函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">function drop(e) &#123;</div><div class="line">  e.stopPropagation();</div><div class="line">  e.preventDefault();</div><div class="line"></div><div class="line">  var dt = e.dataTransfer;</div><div class="line">  var files = dt.files;</div><div class="line"></div><div class="line">  handleFiles(files);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在该函数中,我们从事件对象中获取到dataTransfer对象，把该对象包含的Filelist对象传入函数handleFiles()，这个函数会无区别的对待从input元素或拖放操作中来的文件列表。</p>
<h2 id="栗子：显示用户所选图片的缩略图"><a href="#栗子：显示用户所选图片的缩略图" class="headerlink" title="栗子：显示用户所选图片的缩略图"></a>栗子：显示用户所选图片的缩略图</h2><p>假设你正在开发下一个伟大的照片分享网站，并希望使用HTML5在用户上传他们图片之前进行缩略图预览。您可以如前面所讨论的建立一个输入元素或者拖放区域,并调用一个函数，如下面的 handleFiles 函数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">function handleFiles(files) &#123;</div><div class="line">  for (var i = 0; i &lt; files.length; i++) &#123;</div><div class="line">    var file = files[i];</div><div class="line">    var imageType = /^image\//;</div><div class="line">    </div><div class="line">    if ( !imageType.test(file.type) ) &#123;</div><div class="line">      continue;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    var img = document.createElement(&quot;img&quot;);</div><div class="line">    img.classList.add(&quot;obj&quot;);</div><div class="line">    img.file = file;</div><div class="line">    // 假设 &quot;preview&quot; 是将要展示图片的 div</div><div class="line">    preview.appendChild(img);</div><div class="line">    </div><div class="line">    var reader = new FileReader();</div><div class="line">    reader.onload = (function(aImg) &#123; </div><div class="line">      return function(e) &#123; </div><div class="line">        aImg.src = e.target.result; </div><div class="line">      &#125;; </div><div class="line">    &#125;)(img);</div><div class="line">    reader.readAsDataURL(file);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里我们循环处理用户选择的文件，查看每个文件的类型属性，看看这是否是一个图像文件(通过一个正则表达式匹配字符串“image.*”)。对于每个图片文件，我们创建一个新的img元素。CSS可以用于建立任何漂亮的边界,阴影,和指定图像的大小，所以，甚至不需要在这里完成。</p>
<p>每张图片我们添加一个obj类，让他们更容易的在DOM树中被找到。我们也在图片上添加了一个file属性来确认每张图片的File，这样可以帮助我们在之后真正的上传工作时获取到图片。最后我们使用 Node.appendChild() 把缩略图添加到我们先前的文档区域中。</p>
<p>然后，我们建立了<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader" target="_blank" rel="external">FileReader</a>来处理图片的异步加载,并把它添加到img元素上。在创建新的FileReader对象之后,我们建立了onload函数,然后调用readAsDataURL()开始在后台进行读取操作。当图像文件的所有内容加载后，他们转换成一个 data: URL，传递到onload回调函数中。之后只需要把img元素的src属性设置为这个加载过的图像，就可以让图像的缩略图出现在用户的屏幕上。</p>
<h2 id="使用对象URL"><a href="#使用对象URL" class="headerlink" title="使用对象URL"></a>使用对象URL</h2><p>Gecko2.0(Firefox 4/Thunderbird 3.3/SeaMonkey 2.1)开始支持window.URL.createObjectURL()和 window.URL.revokeObjectURL()两个DOM方法。这两个方法创建简单的URL字符串对象，用于指向任何 DOM File 对象数据，包括用户电脑中的本地文件。</p>
<p>当你想要在HTML中通过URL来引用File对象，你可以参考如下方式创建：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var objectURL = window.URL.createObjectURL(fileObj);</div></pre></td></tr></table></figure></p>
<p>URL对象是 File 对象的一个字符串标识。 每次调用window.URL.createObjectURL()的时候，会创建一个唯一的URL对象，即使你已经为该文件创建了URL对象。这些对象都必须被释放。 当文档被卸载时，它们会自动释放，如果你的页面动态地使用它们，你应该明确地通过调用window.URL.revokeObjectURL()释放它们：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">window.URL.revokeObjectURL(objectURL);</div></pre></td></tr></table></figure></p>
<h2 id="栗子：-使用对象URL来显示图片"><a href="#栗子：-使用对象URL来显示图片" class="headerlink" title="栗子： 使用对象URL来显示图片"></a>栗子： 使用对象URL来显示图片</h2><p>这个例子使用了对象URL来显示图片缩略图，同时还显示了图片的其他信息,包括图片名和图片大小，你可以查看该例子的<a href="https://developer.mozilla.org/samples/domref/file-click-demo.html" target="_blank" rel="external">在线演示</a>。</p>
<p>负责界面呈现的HTML如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;input type=&quot;file&quot; id=&quot;fileElem&quot; multiple accept=&quot;image/*&quot; </div><div class="line">  style=&quot;display：none&quot; onchange=&quot;handleFiles(this.files)&quot;&gt;</div><div class="line">&lt;a href=&quot;#&quot; id=&quot;fileSelect&quot;&gt;Select some files&lt;/a&gt; </div><div class="line">&lt;div id=&quot;fileList&quot;&gt;</div><div class="line">  &lt;p&gt;No files selected!&lt;/p&gt;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure></p>
<p>这建立文件的input元素就像一个调用文件选择器的链接（因为我们要隐藏文件输入，以防止表现出不友好的UI）。这部分将在获取文件所选信息里解释，因为是调用文件选择器的方法。</p>
<p>下面是 handleFiles()方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">window.URL = window.URL || window.webkitURL;</div><div class="line"></div><div class="line">var fileSelect = document.getElementById(&quot;fileSelect&quot;),</div><div class="line">    fileElem = document.getElementById(&quot;fileElem&quot;),</div><div class="line">    fileList = document.getElementById(&quot;fileList&quot;);</div><div class="line"></div><div class="line">fileSelect.addEventListener(&quot;click&quot;, function (e) &#123;</div><div class="line">  if (fileElem) &#123;</div><div class="line">    fileElem.click();</div><div class="line">  &#125;</div><div class="line">  e.preventDefault(); // prevent navigation to &quot;#&quot;</div><div class="line">&#125;, false);</div><div class="line"></div><div class="line">function handleFiles(files) &#123;</div><div class="line">  if (!files.length) &#123;</div><div class="line">    fileList.innerHTML = &quot;&lt;p&gt;No files selected!&lt;/p&gt;&quot;;</div><div class="line">  &#125; else &#123;</div><div class="line">    var list = document.createElement(&quot;ul&quot;);</div><div class="line">    for (var i = 0; i &lt; files.length; i++) &#123;</div><div class="line">      var li = document.createElement(&quot;li&quot;);</div><div class="line">      list.appendChild(li);</div><div class="line">      </div><div class="line">      var img = document.createElement(&quot;img&quot;);</div><div class="line">      img.src = window.URL.createObjectURL(files[i]);</div><div class="line">      img.height = 60;</div><div class="line">      img.onload = function(e) &#123;</div><div class="line">        window.URL.revokeObjectURL(this.src);</div><div class="line">      &#125;</div><div class="line">      li.appendChild(img);</div><div class="line">      </div><div class="line">      var info = document.createElement(&quot;span&quot;);</div><div class="line">      info.innerHTML = files[i].name + &quot;： &quot; + files[i].size + &quot; bytes&quot;;</div><div class="line">      li.appendChild(info);</div><div class="line">    &#125;</div><div class="line">    fileList.appendChild(list);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过 “fileList” ID 获取div。我们将向这个 div 块插入文件列表和略缩图的地方。</p>
<p>假如传递给 handleFiles() 函数的 FileList 对象为 null，那么就设置 div 块的 inner HTML 为 “No files selected!”。否则，我们将按下面的步骤建立文件列表：</p>
<ol>
<li>创建一个无序列表 (ul) 元素。</li>
<li>通过调用 element.appendChild() 方法向 <div> 块插入新的列表项。</div></li>
<li>files 即是 FileList，对于其中的每一个 File ：<ol>
<li>创建一个li元素，并将其插入 list 中。</li>
<li>创建一个img元素.</li>
<li>使用 window.URL.createObjectURL() 创建URL，并设置图片的源为表示文件的新的 URL 对象。</li>
<li>设置图片的 height 为 60 像素。</li>
<li>创建图片的 load 事件句柄以其解除 URL 对象，因为图像载入之后就不再需要 URL。这是通过调用 window.URL.revokeObjectURL() 方法来完成的，用 img.src 传入指定的 URL 对象字符串。</li>
<li>添加新的列表项到列表之中。</li>
</ol>
</li>
</ol>
<h2 id="栗子：上传用户选择的文件"><a href="#栗子：上传用户选择的文件" class="headerlink" title="栗子：上传用户选择的文件"></a>栗子：上传用户选择的文件</h2><p>你可以异步的将用户所选择的文件上传到服务器上(比如一张图片).</p>
<h3 id="创建上传任务"><a href="#创建上传任务" class="headerlink" title="创建上传任务"></a>创建上传任务</h3><p>紧接上面构建缩略图例子中的代码，需要重申的是 每一个略缩图都在 CSS 类 obj 中，而其相应的 File 则是在 file 属性里。这样子，使用 Document.querySelectorAll() 我们就能很容易选择所有用户想要上传的图片：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">function sendFiles() &#123;</div><div class="line">  var imgs = document.querySelectorAll(&quot;.obj&quot;);</div><div class="line">  </div><div class="line">  for (var i = 0; i &lt; imgs.length; i++) &#123;</div><div class="line">    new FileUpload(imgs[i], imgs[i].file);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代码第二行创建了一个 imgs 数组，其包含了 document 中有 CSS 类 obj 的所有元素。在本例中，这些都是略缩图。一旦我们有了这个列表，遍历该列表并为每一个元素创建一个 FileUpload 实例。每个函数都会上传相应的文件。</p>
<h3 id="实现文件上传"><a href="#实现文件上传" class="headerlink" title="实现文件上传"></a>实现文件上传</h3><p>FileUpload 函数接受两个参数：一个 img 元素，一个可以从中读取到图像数据的文件 file。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">function FileUpload(img, file) &#123;</div><div class="line">  var reader = new FileReader();  </div><div class="line">  this.ctrl = createThrobber(img);</div><div class="line">  var xhr = new XMLHttpRequest();</div><div class="line">  this.xhr = xhr;</div><div class="line">  </div><div class="line">  var self = this;</div><div class="line">  this.xhr.upload.addEventListener(&quot;progress&quot;, function(e) &#123;</div><div class="line">        if (e.lengthComputable) &#123;</div><div class="line">          var percentage = Math.round((e.loaded * 100) / e.total);</div><div class="line">          self.ctrl.update(percentage);</div><div class="line">        &#125;</div><div class="line">      &#125;, false);</div><div class="line">  </div><div class="line">  xhr.upload.addEventListener(&quot;load&quot;, function(e)&#123;</div><div class="line">          self.ctrl.update(100);</div><div class="line">          var canvas = self.ctrl.ctx.canvas;</div><div class="line">          canvas.parentNode.removeChild(canvas);</div><div class="line">      &#125;, false);</div><div class="line">  xhr.open(&quot;POST&quot;, </div><div class="line">    &quot;http：//demos.hacks.mozilla.org/paul/demos/resources/webservices/devnull.php&quot;);</div><div class="line">  xhr.overrideMimeType(&apos;text/plain; charset=x-user-defined-binary&apos;);</div><div class="line">  reader.onload = function(evt) &#123;</div><div class="line">    xhr.sendAsBinary(evt.target.result);</div><div class="line">  &#125;;</div><div class="line">  reader.readAsBinaryString(file);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面显示的 FileUpload() 函数创建了一个活动指示器（throbber），其是用于显示相关的进度信息，然后又创建了一个 XMLHttpRequest  去处理上传到服务器的数据。</p>
<p>在实际传输数据之前，需要完成几个步骤：</p>
<ol>
<li>设置 XMLHttpRequest 的 upload progress 监听器以新的百分比信息去更新活动指示器（throbber），并将其作为上传进度，而活动指示器将基于最新的信息进行更新。</li>
<li>设置 XMLHttpRequest 的 upload load 事件句柄更新信息活动指示器的进度直到其为100%（避免过程中的 granularity quirks）。上传完成后活动指示器就会消失。</li>
<li>通过调用的 XMLHttpRequest 的 open() 方法生成一个 POST 请求以其启动图像文件上传。</li>
<li>MIME 类型上传是通过调用 XMLHttpRequest 的函数 overrideMimeType() 设置。在这种情况下，我们使用一个通用的 MIME 类型；你可以选择不设置 MIME 类型，这取决于你的使用情况。</li>
<li>FileReader 对象可以把 file 转换成二进制字符串。</li>
<li>最后，当内容载入完毕的时候就会调用 XMLHttpRequest 的 sendAsBinary() 函数去上传 file 的内容。</li>
</ol>
<h3 id="异步实现文件上传"><a href="#异步实现文件上传" class="headerlink" title="异步实现文件上传"></a>异步实现文件上传</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">if (isset($_FILES[&apos;myFile&apos;])) &#123;</div><div class="line">    // Example：</div><div class="line">    move_uploaded_file($_FILES[&apos;myFile&apos;][&apos;tmp_name&apos;], </div><div class="line">        &quot;uploads/&quot; . $_FILES[&apos;myFile&apos;][&apos;name&apos;]);</div><div class="line">    exit;</div><div class="line">&#125;</div><div class="line">?&gt;&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;title&gt;dnd binary upload&lt;/title&gt;</div><div class="line">    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;</div><div class="line">    &lt;script type=&quot;text/javascript&quot;&gt;</div><div class="line">        function sendFile(file) &#123;</div><div class="line">            var uri = &quot;/index.php&quot;;</div><div class="line">            var xhr = new XMLHttpRequest();</div><div class="line">            var fd = new FormData();</div><div class="line">            </div><div class="line">            xhr.open(&quot;POST&quot;, uri, true);</div><div class="line">            xhr.onreadystatechange = function() &#123;</div><div class="line">                if (xhr.readyState == 4 &amp;&amp; xhr.status == 200) &#123;</div><div class="line">                    // Handle response.</div><div class="line">                    alert(xhr.responseText); // handle response.</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">            fd.append(&apos;myFile&apos;, file);</div><div class="line">            // Initiate a multipart/form-data upload</div><div class="line">            xhr.send(fd);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        window.onload = function() &#123;</div><div class="line">            var dropzone = document.getElementById(&quot;dropzone&quot;);</div><div class="line">            dropzone.ondragover = </div><div class="line">              dropzone.ondragenter = function(event) &#123;</div><div class="line">                event.stopPropagation();</div><div class="line">                event.preventDefault();</div><div class="line">            &#125;</div><div class="line">    </div><div class="line">            dropzone.ondrop = function(event) &#123;</div><div class="line">                event.stopPropagation();</div><div class="line">                event.preventDefault();</div><div class="line"></div><div class="line">                var filesArray = event.dataTransfer.files;</div><div class="line">                for (var i=0; i&lt;filesArray.length; i++) &#123;</div><div class="line">                    sendFile(filesArray[i]);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">    &lt;/script&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;div&gt;</div><div class="line">        &lt;div id=&quot;dropzone&quot; </div><div class="line">          style=&quot;margin：30px; width：500px; height：300px; border：1px dotted grey;&quot;&gt;</div><div class="line">            Drag &amp; drop your file here...</div><div class="line">        &lt;/div&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<h2 id="示例：-使用URLs对象显示-PDF"><a href="#示例：-使用URLs对象显示-PDF" class="headerlink" title="示例： 使用URLs对象显示 PDF"></a>示例： 使用URLs对象显示 PDF</h2><p>URLs对象不仅仅是可用于图像！它们可用于显示嵌入的PDF文件，或可以由浏览器显示的任何其它资源。</p>
<p>在火狐中，使PDF出现在内嵌的iframe中（并不建议作为一个下载的文件），把偏好pdfjs.disabled设置为false 。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;iframe id=&quot;viewer&quot;&gt;</div></pre></td></tr></table></figure></p>
<p>src 属性在这里有些变化：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">var obj_url = window.URL.createObjectURL(blob);</div><div class="line">var iframe = document.getElementById(&apos;viewer&apos;);</div><div class="line">iframe.setAttribute(&apos;src&apos;, obj_url);</div><div class="line">window.URL.revokeObjectURL(obj_url);</div></pre></td></tr></table></figure></p>
<h2 id="示例：其他文件类型使用URLs对象"><a href="#示例：其他文件类型使用URLs对象" class="headerlink" title="示例：其他文件类型使用URLs对象"></a>示例：其他文件类型使用URLs对象</h2><p>你可以用同样的方式操纵其它格式的文件。下面是如何预览上传的视频：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var video = document.getElementById(&apos;video&apos;);</div><div class="line">var obj_url = window.URL.createObjectURL(blob);</div><div class="line">video.src = obj_url;</div><div class="line">video.play()</div><div class="line">window.URL.revokeObjectURL(obj_url);</div></pre></td></tr></table></figure></p>
<p>原文章摘自在<a href="https://developer.mozilla.org/zh-CN/docs/Using_files_from_web_applications" target="_blank" rel="external">web应用中使用文件</a></p>
</div><div class="tags"></div><div class="post-nav"><a href="/2017/03/25/浏览器兼容问题/" class="pre">浏览器兼容问题</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/日志/">日志</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/日志/二级目录/">二级目录</a><span class="category-list-count">2</span></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/网站优化/" style="font-size: 15px;">网站优化</a> <a href="/tags/string/" style="font-size: 15px;">string</a> <a href="/tags/number/" style="font-size: 15px;">number</a> <a href="/tags/array/" style="font-size: 15px;">array</a> <a href="/tags/Math/" style="font-size: 15px;">Math</a> <a href="/tags/浏览器兼容/" style="font-size: 15px;">浏览器兼容</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/04/25/web应用中上传文件/">web应用中上传文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/25/浏览器兼容问题/">浏览器兼容问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/20/日常String、Number、Array、Math和Json方法/">日常String、Number、Array、Math和Json方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/20/前端优化总结/">前端高性能优化</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.3.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:530399239@qq.com" target="_blank" class="fa fa-email"> </a><a href="http://weibo.com/5898588397" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/angeljie889" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">刘杰</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script type="text/javascript" src="/js/search.json.js?v=1.3.0"></script></body></html>